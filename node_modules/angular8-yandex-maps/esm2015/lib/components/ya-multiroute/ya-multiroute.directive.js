import { Directive, EventEmitter, Input, NgZone, Output, } from '@angular/core';
import { Subscription } from 'rxjs';
import { EventManager } from '../../event-manager';
import { YaMapComponent } from '../ya-map/ya-map.component';
/**
 * The `ya-multiroute` component wraps `ymaps.multiRouter.MultiRoute` class from the Yandex Maps API.
 * You can configure it via the component's inputs.
 * Events can be bound using the outputs of the component.
 *
 * <example-url>https://stackblitz.com/edit/multiroute-pedestrian?embed=1</example-url>
 *
 * @example
 * ```html
 * <ya-map [center]="[55.761952, 37.620739]">
 *   <ya-multiroute
 *     [referencePoints]="[[55.751952, 37.600739], 'Красные ворота, Москва']"
 *     [model]="{ params: { routingMode: 'pedestrian' } }"
 *   ></ya-multiroute>
 * </ya-map>
 * ```
 */
export class YaMultirouteDirective {
    constructor(_ngZone, _yaMapComponent) {
        this._ngZone = _ngZone;
        this._yaMapComponent = _yaMapComponent;
        this._sub = new Subscription();
        this._eventManager = new EventManager(this._ngZone);
        /**
         * Multiroute instance is added in a Map.
         */
        this.ready = new EventEmitter();
        /**
         * Change to the active route.
         */
        this.activeroutechange = this._eventManager.getLazyEmitter('activeroutechange');
        /**
         * Closing the balloon.
         */
        this.balloonclose = this._eventManager.getLazyEmitter('balloonclose');
        /**
         * Opening a balloon on a map.
         */
        this.balloonopen = this._eventManager.getLazyEmitter('balloonopen');
        /**
         * The event occurs at the time of setting the map center and its zoom level for optimal display of the multi-route.
         */
        this.boundsautoapply = this._eventManager.getLazyEmitter('boundsautoapply');
        /**
         * Changing coordinates of the geographical area covering the multi-route.
         */
        this.boundschange = this._eventManager.getLazyEmitter('boundschange');
        /**
         * Single left-click on the object.
         */
        this.yaclick = this._eventManager.getLazyEmitter('click');
        /**
         * Calls the element's context menu.
         */
        this.yacontextmenu = this._eventManager.getLazyEmitter('contextmenu');
        /**
         * Double left-click on the object.
         */
        this.yadblclick = this._eventManager.getLazyEmitter('dblclick');
        /**
         * Change to the geo object geometry.
         */
        this.geometrychange = this._eventManager.getLazyEmitter('geometrychange');
        /**
         * Map reference changed.
         */
        this.mapchange = this._eventManager.getLazyEmitter('mapchange');
        /**
         * Pressing the mouse button over the object.
         */
        this.yamousedown = this._eventManager.getLazyEmitter('mousedown');
        /**
         * Pointing the cursor at the object.
         */
        this.yamouseenter = this._eventManager.getLazyEmitter('mouseenter');
        /**
         * Moving the cursor off of the object.
         */
        this.yamouseleave = this._eventManager.getLazyEmitter('mouseleave');
        /**
         * Moving the cursor over the object.
         */
        this.yamousemove = this._eventManager.getLazyEmitter('mousemove');
        /**
         * Letting go of the mouse button over an object.
         */
        this.yamouseup = this._eventManager.getLazyEmitter('mouseup');
        /**
         * End of multitouch.
         */
        this.multitouchend = this._eventManager.getLazyEmitter('multitouchend');
        /**
         * Repeating event during multitouch.
         */
        this.multitouchmove = this._eventManager.getLazyEmitter('multitouchmove');
        /**
         * Start of multitouch.
         */
        this.multitouchstart = this._eventManager.getLazyEmitter('multitouchstart');
        /**
         * Change to the object options.
         */
        this.optionschange = this._eventManager.getLazyEmitter('optionschange');
        /**
         * Change to the geo object overlay.
         */
        this.overlaychange = this._eventManager.getLazyEmitter('overlaychange');
        /**
         * The parent object reference changed.
         */
        this.parentchange = this._eventManager.getLazyEmitter('parentchange');
        /**
         * Changing pixel coordinates of the area covering the multi-route.
         */
        this.pixelboundschange = this._eventManager.getLazyEmitter('pixelboundschange');
        /**
         * Change to the geo object data.
         */
        this.propertieschange = this._eventManager.getLazyEmitter('propertieschange');
        /**
         * Updating the multi-route.
         */
        this.update = this._eventManager.getLazyEmitter('update');
        /**
         * Mouse wheel scrolling.
         */
        this.yawheel = this._eventManager.getLazyEmitter('wheel');
    }
    /**
     * Handles input changes and passes them in API.
     * @param changes
     */
    ngOnChanges(changes) {
        const multiroute = this._multiroute;
        if (multiroute) {
            const { referencePoints, model, options } = changes;
            if (model) {
                this._setModel(model.currentValue, multiroute);
            }
            if (referencePoints) {
                multiroute.model.setReferencePoints(referencePoints.currentValue);
            }
            if (options) {
                multiroute.options.set(options.currentValue);
            }
        }
    }
    ngOnInit() {
        if (this._yaMapComponent.isBrowser) {
            const sub = this._yaMapComponent.map$.subscribe((map) => {
                if (map) {
                    const multiroute = this._createMultiroute();
                    this._multiroute = multiroute;
                    map.geoObjects.add(multiroute);
                    this._eventManager.setTarget(multiroute);
                    this._ngZone.run(() => this.ready.emit({ ymaps, target: multiroute }));
                }
            });
            this._sub.add(sub);
        }
    }
    ngOnDestroy() {
        var _a, _b;
        if (this._multiroute) {
            (_b = (_a = this._yaMapComponent) === null || _a === void 0 ? void 0 : _a.map$.value) === null || _b === void 0 ? void 0 : _b.geoObjects.remove(this._multiroute);
            this._eventManager.destroy();
        }
        this._sub.unsubscribe();
    }
    /**
     * Destructs state and passes them in API.
     * @param model
     * @param multiroute
     */
    _setModel(model, multiroute) {
        const { referencePoints, params } = model;
        if (referencePoints) {
            multiroute.model.setReferencePoints(referencePoints);
        }
        if (params) {
            multiroute.model.setParams(params);
        }
    }
    /**
     * Creates Multiroute.
     */
    _createMultiroute() {
        return new ymaps.multiRouter.MultiRoute(this._combineModel(), this.options);
    }
    /**
     * Combines the model and reference points into single object
     */
    _combineModel() {
        const model = (this.model || {});
        return Object.assign(Object.assign({}, model), { referencePoints: this.referencePoints || model.referencePoints });
    }
}
YaMultirouteDirective.decorators = [
    { type: Directive, args: [{
                selector: 'ya-multiroute',
            },] }
];
YaMultirouteDirective.ctorParameters = () => [
    { type: NgZone },
    { type: YaMapComponent }
];
YaMultirouteDirective.propDecorators = {
    referencePoints: [{ type: Input }],
    model: [{ type: Input }],
    options: [{ type: Input }],
    ready: [{ type: Output }],
    activeroutechange: [{ type: Output }],
    balloonclose: [{ type: Output }],
    balloonopen: [{ type: Output }],
    boundsautoapply: [{ type: Output }],
    boundschange: [{ type: Output }],
    yaclick: [{ type: Output }],
    yacontextmenu: [{ type: Output }],
    yadblclick: [{ type: Output }],
    geometrychange: [{ type: Output }],
    mapchange: [{ type: Output }],
    yamousedown: [{ type: Output }],
    yamouseenter: [{ type: Output }],
    yamouseleave: [{ type: Output }],
    yamousemove: [{ type: Output }],
    yamouseup: [{ type: Output }],
    multitouchend: [{ type: Output }],
    multitouchmove: [{ type: Output }],
    multitouchstart: [{ type: Output }],
    optionschange: [{ type: Output }],
    overlaychange: [{ type: Output }],
    parentchange: [{ type: Output }],
    pixelboundschange: [{ type: Output }],
    propertieschange: [{ type: Output }],
    update: [{ type: Output }],
    yawheel: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtbXVsdGlyb3V0ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyOC15YW5kZXgtbWFwcy9zcmMvbGliL2NvbXBvbmVudHMveWEtbXVsdGlyb3V0ZS95YS1tdWx0aXJvdXRlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUlOLE1BQU0sR0FFUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFTNUQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFJSCxNQUFNLE9BQU8scUJBQXFCO0lBeUxoQyxZQUE2QixPQUFlLEVBQW1CLGVBQStCO1FBQWpFLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFBbUIsb0JBQWUsR0FBZixlQUFlLENBQWdCO1FBeEw3RSxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUUxQixrQkFBYSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQXlCaEU7O1dBRUc7UUFDTyxVQUFLLEdBQTZELElBQUksWUFBWSxFQUV6RixDQUFDO1FBRUo7O1dBRUc7UUFDTyxzQkFBaUIsR0FDekIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUV6RDs7V0FFRztRQUNPLGlCQUFZLEdBQ3BCLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRXBEOztXQUVHO1FBQ08sZ0JBQVcsR0FDbkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENB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QUFNOzBCQU1OLE1BQU07OEJBTU4sTUFBTTsyQkFNTixNQUFNO3NCQU1OLE1BQU07NEJBTU4sTUFBTTt5QkFNTixNQUFNOzZCQU1OLE1BQU07d0JBTU4sTUFBTTswQkFNTixNQUFNOzJCQU1OLE1BQU07MkJBTU4sTUFBTTswQkFNTixNQUFNO3dCQU1OLE1BQU07NEJBTU4sTUFBTTs2QkFNTixNQUFNOzhCQU1OLE1BQU07NEJBTU4sTUFBTTs0QkFNTixNQUFNOzJCQU1OLE1BQU07Z0NBTU4sTUFBTTsrQkFNTixNQUFNO3FCQU1OLE1BQU07c0JBTU4sTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLFxyXG4gIEV2ZW50RW1pdHRlcixcclxuICBJbnB1dCxcclxuICBOZ1pvbmUsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBPbkluaXQsXHJcbiAgT3V0cHV0LFxyXG4gIFNpbXBsZUNoYW5nZXMsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tICcuLi8uLi9ldmVudC1tYW5hZ2VyJztcclxuaW1wb3J0IHsgWWFNYXBDb21wb25lbnQgfSBmcm9tICcuLi95YS1tYXAveWEtbWFwLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFlhUmVhZHlFdmVudCB9IGZyb20gJy4uLy4uL3R5cGluZ3MveWEtcmVhZHktZXZlbnQnO1xyXG5pbXBvcnQgeyBZYUV2ZW50IH0gZnJvbSAnLi4vLi4vdHlwaW5ncy95YS1ldmVudCc7XHJcblxyXG4vKipcclxuICogQGludGVybmFsXHJcbiAqL1xyXG50eXBlIE9wdGlvbmFsPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPiA9IFBpY2s8UGFydGlhbDxUPiwgSz4gJiBPbWl0PFQsIEs+O1xyXG5cclxuLyoqXHJcbiAqIFRoZSBgeWEtbXVsdGlyb3V0ZWAgY29tcG9uZW50IHdyYXBzIGB5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlYCBjbGFzcyBmcm9tIHRoZSBZYW5kZXggTWFwcyBBUEkuXHJcbiAqIFlvdSBjYW4gY29uZmlndXJlIGl0IHZpYSB0aGUgY29tcG9uZW50J3MgaW5wdXRzLlxyXG4gKiBFdmVudHMgY2FuIGJlIGJvdW5kIHVzaW5nIHRoZSBvdXRwdXRzIG9mIHRoZSBjb21wb25lbnQuXHJcbiAqXHJcbiAqIDxleGFtcGxlLXVybD5odHRwczovL3N0YWNrYmxpdHouY29tL2VkaXQvbXVsdGlyb3V0ZS1wZWRlc3RyaWFuP2VtYmVkPTE8L2V4YW1wbGUtdXJsPlxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBodG1sXHJcbiAqIDx5YS1tYXAgW2NlbnRlcl09XCJbNTUuNzYxOTUyLCAzNy42MjA3MzldXCI+XHJcbiAqICAgPHlhLW11bHRpcm91dGVcclxuICogICAgIFtyZWZlcmVuY2VQb2ludHNdPVwiW1s1NS43NTE5NTIsIDM3LjYwMDczOV0sICfQmtGA0LDRgdC90YvQtSDQstC+0YDQvtGC0LAsINCc0L7RgdC60LLQsCddXCJcclxuICogICAgIFttb2RlbF09XCJ7IHBhcmFtczogeyByb3V0aW5nTW9kZTogJ3BlZGVzdHJpYW4nIH0gfVwiXHJcbiAqICAgPjwveWEtbXVsdGlyb3V0ZT5cclxuICogPC95YS1tYXA+XHJcbiAqIGBgYFxyXG4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICd5YS1tdWx0aXJvdXRlJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFlhTXVsdGlyb3V0ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3N1YiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfZXZlbnRNYW5hZ2VyID0gbmV3IEV2ZW50TWFuYWdlcih0aGlzLl9uZ1pvbmUpO1xyXG5cclxuICBwcml2YXRlIF9tdWx0aXJvdXRlPzogeW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZTtcclxuXHJcbiAgLyoqXHJcbiAgICogUmVmZXJlbmNlIHBvaW50cyBmb3IgdGhlIG11bHRpcm91dGUuXHJcbiAgICogU2hvcnRoYW5kIGZvciBbbW9kZWxdPVwieyByZWZlcmVuY2VQb2ludHM6IFswLCAwXSB9XCIuXHJcbiAgICoge0BsaW5rIGh0dHBzOi8veWFuZGV4LmNvbS9kZXYvbWFwcy9qc2FwaS9kb2MvMi4xL3JlZi9yZWZlcmVuY2UvSU11bHRpUm91dGVSZWZlcmVuY2VQb2ludC5odG1sfVxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHJlZmVyZW5jZVBvaW50czogeW1hcHMuSU11bHRpUm91dGVSZWZlcmVuY2VQb2ludFtdO1xyXG5cclxuICAvKipcclxuICAgKiBNb2RlbCBkZXNjcmlwdGlvbiBvYmplY3Qgb2YgYSBtdWx0aXJvdXRlLlxyXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL0lNdWx0aVJvdXRlTW9kZWxKc29uLmh0bWx9XHJcbiAgICovXHJcbiAgQElucHV0KCkgbW9kZWw6XHJcbiAgICB8IHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGVNb2RlbFxyXG4gICAgfCBPcHRpb25hbDx5bWFwcy5JTXVsdGlSb3V0ZU1vZGVsSnNvbiwgJ3JlZmVyZW5jZVBvaW50cyc+O1xyXG5cclxuICAvKipcclxuICAgKiBPcHRpb25zIGZvciB0aGUgbXVsdGlyb3V0ZS5cclxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9tdWx0aVJvdXRlci5NdWx0aVJvdXRlLmh0bWwjbXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZV9fcGFyYW0tb3B0aW9uc31cclxuICAgKi9cclxuICBASW5wdXQoKSBvcHRpb25zOiB5bWFwcy5tdWx0aVJvdXRlci5JTXVsdGlSb3V0ZU9wdGlvbnM7XHJcblxyXG4gIC8qKlxyXG4gICAqIE11bHRpcm91dGUgaW5zdGFuY2UgaXMgYWRkZWQgaW4gYSBNYXAuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHJlYWR5OiBFdmVudEVtaXR0ZXI8WWFSZWFkeUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9IG5ldyBFdmVudEVtaXR0ZXI8XHJcbiAgICBZYVJlYWR5RXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT5cclxuICA+KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIENoYW5nZSB0byB0aGUgYWN0aXZlIHJvdXRlLlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBhY3RpdmVyb3V0ZWNoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2FjdGl2ZXJvdXRlY2hhbmdlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIENsb3NpbmcgdGhlIGJhbGxvb24uXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIGJhbGxvb25jbG9zZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2JhbGxvb25jbG9zZScpO1xyXG5cclxuICAvKipcclxuICAgKiBPcGVuaW5nIGEgYmFsbG9vbiBvbiBhIG1hcC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgYmFsbG9vbm9wZW46IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdiYWxsb29ub3BlbicpO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgZXZlbnQgb2NjdXJzIGF0IHRoZSB0aW1lIG9mIHNldHRpbmcgdGhlIG1hcCBjZW50ZXIgYW5kIGl0cyB6b29tIGxldmVsIGZvciBvcHRpbWFsIGRpc3BsYXkgb2YgdGhlIG11bHRpLXJvdXRlLlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBib3VuZHNhdXRvYXBwbHk6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdib3VuZHNhdXRvYXBwbHknKTtcclxuXHJcbiAgLyoqXHJcbiAgICogQ2hhbmdpbmcgY29vcmRpbmF0ZXMgb2YgdGhlIGdlb2dyYXBoaWNhbCBhcmVhIGNvdmVyaW5nIHRoZSBtdWx0aS1yb3V0ZS5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgYm91bmRzY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignYm91bmRzY2hhbmdlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFNpbmdsZSBsZWZ0LWNsaWNrIG9uIHRoZSBvYmplY3QuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHlhY2xpY2s6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdjbGljaycpO1xyXG5cclxuICAvKipcclxuICAgKiBDYWxscyB0aGUgZWxlbWVudCdzIGNvbnRleHQgbWVudS5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgeWFjb250ZXh0bWVudTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2NvbnRleHRtZW51Jyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIERvdWJsZSBsZWZ0LWNsaWNrIG9uIHRoZSBvYmplY3QuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHlhZGJsY2xpY2s6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdkYmxjbGljaycpO1xyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2UgdG8gdGhlIGdlbyBvYmplY3QgZ2VvbWV0cnkuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIGdlb21ldHJ5Y2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignZ2VvbWV0cnljaGFuZ2UnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIHJlZmVyZW5jZSBjaGFuZ2VkLlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBtYXBjaGFuZ2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdtYXBjaGFuZ2UnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogUHJlc3NpbmcgdGhlIG1vdXNlIGJ1dHRvbiBvdmVyIHRoZSBvYmplY3QuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHlhbW91c2Vkb3duOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbW91c2Vkb3duJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFBvaW50aW5nIHRoZSBjdXJzb3IgYXQgdGhlIG9iamVjdC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgeWFtb3VzZWVudGVyOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbW91c2VlbnRlcicpO1xyXG5cclxuICAvKipcclxuICAgKiBNb3ZpbmcgdGhlIGN1cnNvciBvZmYgb2YgdGhlIG9iamVjdC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgeWFtb3VzZWxlYXZlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbW91c2VsZWF2ZScpO1xyXG5cclxuICAvKipcclxuICAgKiBNb3ZpbmcgdGhlIGN1cnNvciBvdmVyIHRoZSBvYmplY3QuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHlhbW91c2Vtb3ZlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbW91c2Vtb3ZlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIExldHRpbmcgZ28gb2YgdGhlIG1vdXNlIGJ1dHRvbiBvdmVyIGFuIG9iamVjdC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgeWFtb3VzZXVwOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbW91c2V1cCcpO1xyXG5cclxuICAvKipcclxuICAgKiBFbmQgb2YgbXVsdGl0b3VjaC5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgbXVsdGl0b3VjaGVuZDogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ211bHRpdG91Y2hlbmQnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogUmVwZWF0aW5nIGV2ZW50IGR1cmluZyBtdWx0aXRvdWNoLlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBtdWx0aXRvdWNobW92ZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ211bHRpdG91Y2htb3ZlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0YXJ0IG9mIG11bHRpdG91Y2guXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIG11bHRpdG91Y2hzdGFydDogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ211bHRpdG91Y2hzdGFydCcpO1xyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2UgdG8gdGhlIG9iamVjdCBvcHRpb25zLlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBvcHRpb25zY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignb3B0aW9uc2NoYW5nZScpO1xyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2UgdG8gdGhlIGdlbyBvYmplY3Qgb3ZlcmxheS5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgb3ZlcmxheWNoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ292ZXJsYXljaGFuZ2UnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIHBhcmVudCBvYmplY3QgcmVmZXJlbmNlIGNoYW5nZWQuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHBhcmVudGNoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ3BhcmVudGNoYW5nZScpO1xyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2luZyBwaXhlbCBjb29yZGluYXRlcyBvZiB0aGUgYXJlYSBjb3ZlcmluZyB0aGUgbXVsdGktcm91dGUuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHBpeGVsYm91bmRzY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcigncGl4ZWxib3VuZHNjaGFuZ2UnKTtcclxuXHJcbiAgLyoqXHJcbiAgICogQ2hhbmdlIHRvIHRoZSBnZW8gb2JqZWN0IGRhdGEuXHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHByb3BlcnRpZXNjaGFuZ2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlPj4gPVxyXG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdwcm9wZXJ0aWVzY2hhbmdlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0aW5nIHRoZSBtdWx0aS1yb3V0ZS5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgdXBkYXRlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZT4+ID1cclxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcigndXBkYXRlJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIE1vdXNlIHdoZWVsIHNjcm9sbGluZy5cclxuICAgKi9cclxuICBAT3V0cHV0KCkgeWF3aGVlbDogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLm11bHRpUm91dGVyLk11bHRpUm91dGU+PiA9XHJcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ3doZWVsJyk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX25nWm9uZTogTmdab25lLCBwcml2YXRlIHJlYWRvbmx5IF95YU1hcENvbXBvbmVudDogWWFNYXBDb21wb25lbnQpIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZXMgaW5wdXQgY2hhbmdlcyBhbmQgcGFzc2VzIHRoZW0gaW4gQVBJLlxyXG4gICAqIEBwYXJhbSBjaGFuZ2VzXHJcbiAgICovXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgY29uc3QgbXVsdGlyb3V0ZSA9IHRoaXMuX211bHRpcm91dGU7XHJcblxyXG4gICAgaWYgKG11bHRpcm91dGUpIHtcclxuICAgICAgY29uc3QgeyByZWZlcmVuY2VQb2ludHMsIG1vZGVsLCBvcHRpb25zIH0gPSBjaGFuZ2VzO1xyXG5cclxuICAgICAgaWYgKG1vZGVsKSB7XHJcbiAgICAgICAgdGhpcy5fc2V0TW9kZWwobW9kZWwuY3VycmVudFZhbHVlLCBtdWx0aXJvdXRlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHJlZmVyZW5jZVBvaW50cykge1xyXG4gICAgICAgIG11bHRpcm91dGUubW9kZWwuc2V0UmVmZXJlbmNlUG9pbnRzKHJlZmVyZW5jZVBvaW50cy5jdXJyZW50VmFsdWUpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgIG11bHRpcm91dGUub3B0aW9ucy5zZXQob3B0aW9ucy5jdXJyZW50VmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl95YU1hcENvbXBvbmVudC5pc0Jyb3dzZXIpIHtcclxuICAgICAgY29uc3Qgc3ViID0gdGhpcy5feWFNYXBDb21wb25lbnQubWFwJC5zdWJzY3JpYmUoKG1hcCkgPT4ge1xyXG4gICAgICAgIGlmIChtYXApIHtcclxuICAgICAgICAgIGNvbnN0IG11bHRpcm91dGUgPSB0aGlzLl9jcmVhdGVNdWx0aXJvdXRlKCk7XHJcbiAgICAgICAgICB0aGlzLl9tdWx0aXJvdXRlID0gbXVsdGlyb3V0ZTtcclxuXHJcbiAgICAgICAgICBtYXAuZ2VvT2JqZWN0cy5hZGQobXVsdGlyb3V0ZSk7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudE1hbmFnZXIuc2V0VGFyZ2V0KG11bHRpcm91dGUpO1xyXG4gICAgICAgICAgdGhpcy5fbmdab25lLnJ1bigoKSA9PiB0aGlzLnJlYWR5LmVtaXQoeyB5bWFwcywgdGFyZ2V0OiBtdWx0aXJvdXRlIH0pKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy5fc3ViLmFkZChzdWIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5fbXVsdGlyb3V0ZSkge1xyXG4gICAgICB0aGlzLl95YU1hcENvbXBvbmVudD8ubWFwJC52YWx1ZT8uZ2VvT2JqZWN0cy5yZW1vdmUodGhpcy5fbXVsdGlyb3V0ZSk7XHJcbiAgICAgIHRoaXMuX2V2ZW50TWFuYWdlci5kZXN0cm95KCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEZXN0cnVjdHMgc3RhdGUgYW5kIHBhc3NlcyB0aGVtIGluIEFQSS5cclxuICAgKiBAcGFyYW0gbW9kZWxcclxuICAgKiBAcGFyYW0gbXVsdGlyb3V0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgX3NldE1vZGVsKFxyXG4gICAgbW9kZWw6IHltYXBzLklNdWx0aVJvdXRlTW9kZWxKc29uLFxyXG4gICAgbXVsdGlyb3V0ZTogeW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZSxcclxuICApOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgcmVmZXJlbmNlUG9pbnRzLCBwYXJhbXMgfSA9IG1vZGVsO1xyXG5cclxuICAgIGlmIChyZWZlcmVuY2VQb2ludHMpIHtcclxuICAgICAgbXVsdGlyb3V0ZS5tb2RlbC5zZXRSZWZlcmVuY2VQb2ludHMocmVmZXJlbmNlUG9pbnRzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocGFyYW1zKSB7XHJcbiAgICAgIG11bHRpcm91dGUubW9kZWwuc2V0UGFyYW1zKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIE11bHRpcm91dGUuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBfY3JlYXRlTXVsdGlyb3V0ZSgpOiB5bWFwcy5tdWx0aVJvdXRlci5NdWx0aVJvdXRlIHtcclxuICAgIHJldHVybiBuZXcgeW1hcHMubXVsdGlSb3V0ZXIuTXVsdGlSb3V0ZSh0aGlzLl9jb21iaW5lTW9kZWwoKSwgdGhpcy5vcHRpb25zKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbWJpbmVzIHRoZSBtb2RlbCBhbmQgcmVmZXJlbmNlIHBvaW50cyBpbnRvIHNpbmdsZSBvYmplY3RcclxuICAgKi9cclxuICBwcml2YXRlIF9jb21iaW5lTW9kZWwoKTogeW1hcHMuSU11bHRpUm91dGVNb2RlbEpzb24ge1xyXG4gICAgY29uc3QgbW9kZWwgPSAodGhpcy5tb2RlbCB8fCB7fSkgYXMgeW1hcHMuSU11bHRpUm91dGVNb2RlbEpzb247XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgLi4ubW9kZWwsXHJcbiAgICAgIHJlZmVyZW5jZVBvaW50czogdGhpcy5yZWZlcmVuY2VQb2ludHMgfHwgbW9kZWwucmVmZXJlbmNlUG9pbnRzLFxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl19